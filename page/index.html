<html>
    <head>
        <title>Faring Factory</title>
        <script type="text/javascript">

var path = new Array();
// height, radius
path[0] = [0.0,1.0];
path[1] = [3.0,1.0];
path[2] = [3.6,0.6];
path[3] = [4.0,0.0];

var cuts = new Array();
cuts[0] = 0.0;
cuts[1] = 2.0;
cuts[2] = 4.0;

var mouse_status = "hover";

function setup(){
    var canvas = document.getElementById("usp");
    var mouseX,mouseY;
    
    canvas.addEventListener('mousemove', function(evt) {
        var rect = canvas.getBoundingClientRect(), root = document.documentElement;
        // relative mouse position
        //console.log(rect.top, rect.left)
        mouseX = evt.clientX - rect.left;// - root.scrollTop;
        mouseY = evt.clientY - rect.top;// - root.scrollLeft;
        draw(mouseX,mouseY);
    }, false);
    
    canvas.addEventListener('mouseup', function(evt) {
        var rect = canvas.getBoundingClientRect(), root = document.documentElement;
        // relative mouse position
        //console.log(rect.top, rect.left)
        mouseX = evt.clientX - rect.left;// - root.scrollTop;
        mouseY = evt.clientY - rect.top;// - root.scrollLeft;

        if (mouse_status == "hover"){
            if (mouseX < 20){
                mouse_status = "holding_cut"
            } else {
                mouse_status = "holding_point"
            }
        } else if (mouse_status == "holding_cut") {
            // apply cut
            mouse_status = "hover";
        } else if (mouse_status == "holding_point") {
            // apply new point
            mouse_status = "hover";
        }
        console.log(mouse_status)
        draw(mouseX,mouseY);
    }, false);

    
    draw(-100,0);
}


function fco_to_cvco(rad,height){
    return {
        'x': 390+rad*180,
        'y': 800-height*180
    };
}

function cvco_to_fco(cx,cy){
    return {
        'rad': (cx-390)/180,
        'height': (800-cy)/180
    };
}

function labelVertGuide(ctx, rad, str){
    ctx.strokeStyle = "rgb(250,250,250)";
    ctx.font = 'italic 12px Calibri';
    ctx.fillStyle = "rgb(220,220,200)";
    ctx.beginPath();
    ptg = fco_to_cvco(rad,0)
    x = ptg.x + 0.5
    ctx.moveTo(x, 0);
    ctx.lineTo(x, 800);
    ctx.stroke();
    ctx.fillText(str, x+1.5, 10);
}
        
function draw(mouseX,mouseY){
    var canvas = document.getElementById("usp");
    if (canvas.getContext){
        var ctx = canvas.getContext("2d");

        // width: 800, height: 800

        ctx.fillStyle = "rgb(180,180,180)";
        ctx.fillRect (0, 0, 800, 800);
        
        ctx.fillStyle = "rgb(212,95,0)";
        ctx.fillRect (0, 0, 20, 800);
        ctx.strokeStyle = "rgb(0,0,0)";
        ctx.beginPath();
        ctx.moveTo(20, 0);
        ctx.lineTo(20, 800);
        ctx.stroke();

        // light 1m 2m 3m lines
        labelVertGuide(ctx, 0, '0m')
        labelVertGuide(ctx, -1, '1m')
        labelVertGuide(ctx, 1, '1m')
        labelVertGuide(ctx, -2, '2m')
        labelVertGuide(ctx, 2, '2m')
        labelVertGuide(ctx, -3, '3m')
        labelVertGuide(ctx, 3, '3m')

        // left profile
        ctx.beginPath();
        ctx.strokeStyle = "rgb(0,0,0)";
        for(var i=0; i<path.length; i++){
            var np = path[i];
            var cvco = fco_to_cvco(np[1], np[0]);
            if (i==0){
                ctx.moveTo(cvco.x, cvco.y);
            } else {
                ctx.lineTo(cvco.x, cvco.y);
            }
        }
        ctx.stroke();

        // right profile
        ctx.beginPath();
        ctx.strokeStyle = "rgb(0,0,0)";
        for(var i=0; i<path.length; i++){
            var np = path[i];
            var cvco = fco_to_cvco(-1*np[1], np[0]);
            if (i==0){
                ctx.moveTo(cvco.x, cvco.y);
            } else {
                ctx.lineTo(cvco.x, cvco.y);
            }
        }
        ctx.stroke();

        // existing cuts
        for(var i=0; i<cuts.length; i++){
            var cvco = fco_to_cvco(0, cuts[i]);
            // plain clor
            ctx.strokeStyle = "rgb(200,45,0)";
            // if not first or last cut (special)
            if (!(i==0) && !(i==(cuts.length-1))){
                if (Math.abs(mouseY-cvco.y)<10 && mouse_status=="hover" && mouseX<20){
                    ctx.strokeStyle = "rgb(255,255,0)";
                }
            }
            ctx.beginPath();
            ctx.moveTo(0, cvco.y);
            ctx.lineTo(800, cvco.y);
            ctx.stroke();
        }

        if (mouse_status == "hover"){
            if (mouseX>20){
                // hover main editor area
                for(var i=1; i<path.length; i++){
                    var np = path[i];
                    var cvco = fco_to_cvco(np[1], np[0]);
                    if (cvco.y < mouseY){
                        var pco = fco_to_cvco(path[i-1][1], path[i-1][0]);
                        // hovering above pco and below cvco
                        var true_xpos = (mouseY - cvco.y) / (cvco.y - pco.y) * (cvco.x - pco.x) + cvco.x
                        // mouse dot
                        ctx.beginPath();
                        ctx.arc(true_xpos, mouseY, 6, 0, 2 * Math.PI, false);
                        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                        ctx.fill();
                        // other side
                        var fairing_co = cvco_to_fco(true_xpos, mouseY);
                        var canvas_co = fco_to_cvco(-1*fairing_co.rad, fairing_co.height);
                        ctx.beginPath();
                        ctx.arc(canvas_co.x, mouseY, 6, 0, 2 * Math.PI, false);
                        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                        ctx.fill();
                        break;
                    }
                }
            } else {
                // hover orange cut box
                //ctx.strokeStyle = "rgb(255,255,0)";
                //ctx.beginPath();
                //ctx.moveTo(0, mouseY);
                //ctx.lineTo(800, mouseY);
                //ctx.stroke();
            }
        }
    }
}
        </script>
        <style type="text/css">

body {
    font-family: "Arial", Helvetica, sans-serif;
    font-size: 18pt;
}
        
canvas {
    border: 2px solid rgb(100,100,100);
    float: left;
}

div.left {
    width: 180px;
    float: left;
    padding: 8px;
}

div.right {
    width: 380px;
    float: left;
    padding: 8px;
}

div.clear {
    display: block;
    clear: both;
    height: 0px;
    margin: 0px;
    font-size: 1px;
    line-height: 0;
}
        </style>
    </head>
    <body onLoad="setup();">
        <div style="width: 100%; height: 850px; padding: 10px; background-color: rgb(210,210,210)">
            <div class="left">
                Fairing<br>Factory<br>
                <br>
                <br>
                <small>
                    <ol>
                        <li>Select a base size.</li>
                        <br>
                        <li>Place points along the outline of your fairing by clicking inside the editor area.</li>
                        <br>
                        <li>Cut your fairing into sections by clicking in the orange cut area.</li>
                        <br>
                        <li>Choose a texture for your kit.</li>
                    </ol>
                </small>
            </div>
            <canvas id="usp" width=800 height=800></canvas>
            <div class="right">
                Bla Bla explanation
            </div>
            <div class="clear"></div>
        </div>
    </body>
</html>
